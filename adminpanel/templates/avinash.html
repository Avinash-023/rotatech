<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game with Dynamic Words</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .game-container {
      background: white;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
      text-align: center;
    }

    h1 {
      color: #2d3748;
      margin-bottom: 1.5rem;
      font-size: 2rem;
    }

    .button {
      background-color: #4299e1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
      width: 100%;
      margin: 8px 0;
    }

    .button:hover {
      background-color: #3182ce;
    }

    .button.secondary {
      background-color: #edf2f7;
      color: #2d3748;
      border: 1px solid #e2e8f0;
    }

    .button.secondary:hover {
      background-color: #e2e8f0;
    }

    .input-field {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: #4299e1;
    }

    .feedback {
      margin: 1rem 0;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }

    .feedback.success {
      background-color: #c6f6d5;
      color: #276749;
    }

    .feedback.error {
      background-color: #fed7d7;
      color: #9b2c2c;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      color: #4a5568;
      font-size: 0.875rem;
    }

    .button-group {
      display: flex;
      gap: 8px;
    }

    .button-group .button {
      flex: 1;
    }

    .game-summary {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="game-container">
    <h1>Listen and Type Game</h1>

    <button id="playButton" class="button">Play Word</button>
    <input type="text" id="userInput" class="input-field" placeholder="Type what you hear..." autocomplete="off">
    <div class="button-group">
      <button id="checkButton" class="button secondary">Check Answer</button>
      <button id="resetButton" class="button secondary">Reset Game</button>
      <button id="repeatButton" class="button secondary">Repeat Word</button>
    </div>
    <div id="feedback" class="feedback"></div>
    <div class="stats">
      <span id="score">Score: 0</span>
    </div>

    <input type="hidden" id="csrfToken" value="{{ csrf_token }}">

    <div class="game-summary" id="gameSummary"></div>
    <a class="result" href='/finalresult'>VIEW THE RESULT</a>
  </div>

  <script>
    var serializedData = '{{ serialized_data|safe|escapejs }}';
    console.log(serializedData);

    if (serializedData) {
        try {
            var listData = JSON.parse(serializedData);
            console.log(listData);
        } catch (e) {
            console.error("Error parsing JSON: ", e);
        }
    } else {
        console.error("Serialized data is empty or invalid");
    }

    class ListenTypeGame {
      constructor() {
        this.currentWord = '';
        this.score = 0;
        this.usedWords = [];
        this.speechPitch = 1;
        this.speechRate = 1;
        this.gameFinished = false;

        this.initializeElements();
        this.attachEventListeners();
      }

      initializeElements() {
        this.userInput = document.getElementById('userInput');
        this.feedbackElement = document.getElementById('feedback');
        this.scoreElement = document.getElementById('score');
        this.playButton = document.getElementById('playButton');
        this.checkButton = document.getElementById('checkButton');
        this.resetButton = document.getElementById('resetButton');
        this.repeatButton = document.getElementById('repeatButton');
        this.gameSummary = document.getElementById('gameSummary');
        this.csrfToken = document.getElementById('csrfToken').value;
      }

      getRandomWord() {
        if (listData.length > 0) {
          const unusedWords = listData.filter(word => !this.usedWords.includes(word));
          if (unusedWords.length > 0) {
            const randomWord = unusedWords[Math.floor(Math.random() * unusedWords.length)];
            this.usedWords.push(randomWord);
            return randomWord;
          } else {
            this.gameFinished = true;
            return ''; 
          }
        } else {
          return ''; 
        }
      }

      playWord() {
        if (this.gameFinished) {
          this.showGameSummary();
          return;
        }

        this.currentWord = this.getRandomWord();
        if (this.currentWord === '') {
          this.showFeedback('No more words available!', 'error');
          this.showGameSummary();
          return;
        }

        this.speakWord(this.currentWord);
        this.userInput.value = '';
        this.feedbackElement.className = 'feedback';
        this.feedbackElement.textContent = '';
        this.userInput.focus();
      }

      speakWord(word) {
        const speech = new SpeechSynthesisUtterance(word);
        speech.lang = 'en-US';
        speech.pitch = this.speechPitch;
        speech.rate = this.speechRate;
        window.speechSynthesis.speak(speech);
      }

      repeatWord() {
        if (this.currentWord) {
          this.speakWord(this.currentWord);
        }
      }

      checkAnswer() {
        if (!this.currentWord) {
          this.showFeedback('Please play a word first!', 'error');
          return;
        }

        const userInput = this.userInput.value.toLowerCase().trim();
        const isCorrect = userInput === this.currentWord;
        if (isCorrect) {
          this.score++;
          this.showFeedback('Correct! ðŸŽ‰', 'success');
        } else {
          this.score--;
          this.showFeedback('Try again! ðŸ¤”', 'error');
        }

        this.scoreElement.textContent = `Score: ${this.score}`;

        // Send game result to both endpoints
        this.sendGameResult(this.currentWord, this.currentWord, userInput, isCorrect);
        this.sendGameResult2(this.currentWord, this.currentWord, userInput, isCorrect);

        if (!this.gameFinished) {
          setTimeout(() => this.playWord(), 1000);
        }
      }

      showFeedback(message, type) {
        this.feedbackElement.textContent = message;
        this.feedbackElement.className = `feedback ${type}`;
      }

      showGameSummary() {
        this.gameSummary.textContent = `Game Over! Your final score is: ${this.score}`;
      }

      resetGame() {
        this.score = 0;
        this.scoreElement.textContent = 'Score: 0';
        this.currentWord = '';
        this.usedWords = [];
        this.gameFinished = false;
        this.userInput.value = '';
        this.feedbackElement.className = 'feedback';
        this.feedbackElement.textContent = '';
        this.gameSummary.textContent = '';
      }

      attachEventListeners() {
        this.playButton.addEventListener('click', () => this.playWord());
        this.checkButton.addEventListener('click', () => this.checkAnswer());
        this.resetButton.addEventListener('click', () => this.resetGame());
        this.repeatButton.addEventListener('click', () => this.repeatWord());
      }

      sendGameResult(word, correctAnswer, userAnswer, isCorrect) {
        fetch('/graph2/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': this.csrfToken
            },
            body: `word=${encodeURIComponent(word)}&correct_answer=${encodeURIComponent(correctAnswer)}&user_answer=${encodeURIComponent(userAnswer)}&is_correct=${encodeURIComponent(isCorrect)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Game result saved successfully.');
            } else {
                console.log('Error saving result:', data.message);
            }
        })
        .catch(error => console.error('Error:', error));
      }

      sendGameResult2(word, correctAnswer, userAnswer, isCorrect) {
        fetch('/leaderboarda/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': this.csrfToken
            },
            body: `word=${encodeURIComponent(word)}&correct_answer=${encodeURIComponent(correctAnswer)}&user_answer=${encodeURIComponent(userAnswer)}&is_correct=${encodeURIComponent(isCorrect)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Leaderboard result saved successfully.');
            } else {
                console.log('Error saving leaderboard result:', data.message);
            }
        })
        .catch(error => console.error('Error:', error));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new ListenTypeGame();
    });
  </script>
</body>
</html>
